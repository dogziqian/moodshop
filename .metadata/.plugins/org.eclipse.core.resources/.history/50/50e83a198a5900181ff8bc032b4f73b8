package com.moodshop.controller;

import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.moodshop.comm.pojo.EasyUIDataGridResult;
import com.moodshop.comm.pojo.MSResult;
import com.moodshop.comm.utils.HttpClientUtil;
import com.moodshop.pojo.TbItem;
import com.moodshop.service.ItemService;
/**
 * 商品处理controller
 * @author Administrator
 *
 */
@Controller
public class ItemController {
	
	private final static Logger logger=Logger.getLogger(ItemController.class);
	
	@Autowired
	private ItemService itemService;
	
	@Value("${REST_BASE_URL}")
	private String REST_BASE_URL;
	@Value("${REST_IEM_SYNC_URL}")
	private String REST_IEM_SYNC_URL;
	
	/**
	 * 根据商品id获取商品
	 * @param itemId
	 * @return
	 */
	@RequestMapping("/item/{itemId}")
	@ResponseBody
	private TbItem getItemById(@PathVariable Long itemId){
		logger.info("根据商品id获取商品........");
		logger.info("前段传递参数--------itemId"+itemId);
		TbItem item=itemService.getItemById(itemId);
		return item;
	}
	/**
	 * 获取分页列表
	 * @param page
	 * @param rows
	 * @return
	 */
	@RequestMapping("/item/list")
	@ResponseBody
	public EasyUIDataGridResult getItemList(Integer page,Integer rows){
		logger.info("开始获取分页列表");
		EasyUIDataGridResult result=itemService.getItemList(page, rows);
		return result;
	}
	/**
	 * 新增商品
	 * @return
	 */
	@RequestMapping(value="/item/save",method=RequestMethod.POST)
	@ResponseBody
	public MSResult createItem(TbItem item,String desc,String itemParams){
		logger.info("新增商品.......");		
		MSResult result=itemService.createItem(item, desc,itemParams);
		return result;
	}
	/**
	 * 显示商品参数
	 * @param itemId
	 * @param model
	 * @return
	 */
	@RequestMapping("/page/item/{itemId}")
	public String showItemParam(@PathVariable Long itemId, Model model) {
		logger.info("前段传递参数--------"+itemId);
		String html = itemService.getItemParamHtml(itemId);
		model.addAttribute("html", html);
		return"item-param";
	}
	/**
	 * 下架商品
	 * @param id
	 * @return
	 */
	@RequestMapping("/item/instock")
	public MSResult instockItem(@RequestParam("ids") Long id){
		
		logger.info("下架商品....");
		logger.info("前端传递参数为：id="+id);
		itemService.updateItemStatus(id, (byte) 2);
		
		logger.info("同步缓存信息.....");
		HttpClientUtil.doGet(REST_BASE_URL+REST_IEM_SYNC_URL+id);
		
		return MSResult.ok();
		
	}
	/**
	 * 上架商品
	 * @param id
	 * @return
	 */
	@RequestMapping("/item/reshelf")
	public MSResult reshelfItem(@RequestParam("ids") Long id){
		
		logger.info("上架商品....");
		logger.info("前端传递参数为：id="+id);
		itemService.updateItemStatus(id, (byte) 1);
		
		logger.info("同步缓存信息.....");
		HttpClientUtil.doGet(REST_BASE_URL+REST_IEM_SYNC_URL+id);
		
		return MSResult.ok();
	}
	/**
	 * 删除商品
	 * @param id
	 * @return
	 */
	@RequestMapping("/item/delete")
	public MSResult deleteItem(@RequestParam("ids") Long id){
		
		logger.info("删除商品....");
		logger.info("前端传递参数为：id="+id);
		MSResult result=itemService.updateItemStatus(id, (byte) 3);
		
		logger.info("同步缓存信息.....");
		HttpClientUtil.doGet(REST_BASE_URL+REST_IEM_SYNC_URL+id);
		
		return result;
	}
	/**
	 * 修改商品信息
	 * @param id
	 * @param item
	 * @return
	 */
	@RequestMapping("/item/update")
	public MSResult updateItem(@RequestParam("ids") Long itemId,TbItem item,String desc,String itemParams){
		
		logger.info("修改商品信息....");
		logger.info("前端传递参数为：id="+itemId+",Tbitem="+item);
		
		MSResult result=itemService.updateItem(itemId, item, desc, itemParams);
		
		logger.info("同步缓存信息.....");
		HttpClientUtil.doGet(REST_BASE_URL+REST_IEM_SYNC_URL+itemId);
		
		return result;
	}
}
